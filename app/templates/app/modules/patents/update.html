{% extends 'app/layout.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load super_filters %}

{% block title %}
	Rhinestone Inventions Disclosure Tools | Patent
{% endblock title %}

{% block css %}
<!-- vendor css -->
<link rel="stylesheet" href="{% static 'assets/css/plugins/dataTables.bootstrap4.min.css' %}">
<link rel="stylesheet" href="{% static 'assets/css/plugins/select2.min.css' %}">
<link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
<link rel="stylesheet" href="{% static 'app/css/style.css' %}">
{% endblock css %}
	

{% block content %}
<!-- [ Main Content ] start -->
<div class="pcoded-content">
    <!-- [ breadcrumb ] start -->
    <div class="page-header">
        <div class="page-block">
            <div class="row align-items-center">
                <div class="col-md-12">
                    <div class="page-header-title">
                        <h5 class="m-b-10">Patent Module</h5>
                    </div>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/app/"><i class="feather icon-home"></i>&nbsp;Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="/app/modules/patents/list/">Patent List</a></li>
                        <li class="breadcrumb-item"><a href="/app/modules/patents/add/">Patent Add</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- [ breadcrumb ] end -->
    
    <!-- [ Main Content ] start -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-12 mb-4">
                            <form action="/app/modules/patents/edit/{{ item.id }}" method="post" class="page-form">
                                {% csrf_token %}
                                <!-- Top Buttons -->
                                <div class="form-row" style="margin-bottom: 10px; text-align: right;">
                                    <div class="col-12">
                                        <button class="btn btn-sm btn-outline-primary"><i class="feather icon-arrow-left"></i></button>
                                        <button class="btn btn-sm btn-outline-primary"><i class="feather icon-arrow-right"></i></button>
                                        <button class="btn btn-sm btn-outline-primary"><i class="feather icon-printer"></i></button>
                                        <button type="reset" class="btn btn-sm btn-outline-primary"><i class="feather icon-delete"></i>&nbsp;Delete</button>
                                        <button type="submit" class="btn btn-sm btn-outline-primary"><i class="feather icon-save"></i>&nbsp;Save</button>
                                    </div>
                                </div>
    
                                <!-- Top Fields -->
                                <div class="form-row" style="margin-bottom: 1px;">
                                    <div class="col-md-3">{{ form.case_no|as_crispy_field }}</div>
                                    <div class="col-md-3">{{ form.country|as_crispy_field }}</div>
                                    <div class="col-md-3">{{ form.internal_title|as_crispy_field }}</div>
                                    <div class="col-md-3">{{ form.formal_title|as_crispy_field }}</div>
                                </div>
                                <div class="form-row" style="margin-bottom: 8px;">
                                    <div class="col-md-3">{{ form.status|as_crispy_field }}</div>
                                    <div class="col-md-3">{{ form.sub_status|as_crispy_field }}</div>
                                    <div class="col-md-3">{{ form.filing_type|as_crispy_field }}</div>
                                    <div class="col-md-3">{{ form.sub_filing_type|as_crispy_field }}</div>
                                </div>
                                <div class="form-row" style="margin-bottom: 8px;">
                                    <div class="col-md-3">{{ form.primary_attorney|as_crispy_field }}</div>
                                    <div class="col-md-3">{{ form.case_type|as_crispy_field }}</div>
                                    <div class="col-md-3">{{ form.licence|as_crispy_field }}</div>
                                    <div class="col-md-3">{{ form.taxs_paid_by|as_crispy_field }}</div>
                                </div>
                                <div class="form-row" style="margin-bottom: 8px;">
                                    <div class="col-md-3">{{ form.official_number|as_crispy_field }}</div>
                                    <div class="col-md-3">{{ form.priority_provisional_application_no|as_crispy_field }}</div>
                                    
                                    <div class="col-md-6">{{ form.priority_provisional_date|as_crispy_field }}</div>
                                     <script>
        document.addEventListener("DOMContentLoaded", function () {
            const dateField = document.querySelector('[name="priority_provisional_date"]');
            if (dateField) {
                dateField.setAttribute('placeholder', 'dd/mm/yyyy');
                dateField.setAttribute('type', 'date');
            }
        });
    </script>
                                </div>
    
                                <!-- Hidden Fields for Dynamic Tabs -->
                                <div id="names-section" style="display: none;">
                                    <div class="form-row">
                                        <div class="col-md-4">{{ form.associate|as_crispy_field }}</div>
                                        <div class="col-md-4">{{ form.associate_ref|as_crispy_field }}</div>
                                        <div class="col-md-4">{{ form.associate_2|as_crispy_field }}</div>
                                    </div>
                                    <div class="form-row">
                                        <div class="col-md-4">{{ form.secondary_attorney|as_crispy_field }}</div>
                                        <div class="col-md-4">{{ form.primary_paralegal|as_crispy_field }}</div>
                                        <div class="col-md-4">{{ form.secondary_paralegal|as_crispy_field }}</div>
                                    </div>
                                    <div class="form-row">
                                        <div class="col-md-4">{{ form.cost_centre|as_crispy_field }}</div>
                                        <div class="col-md-4">{{ form.cost_centre_code|as_crispy_field }}</div>
                                    </div>
                                </div>
    
                                <div id="official-numbers-section" style="display: none;">
                                    <div class="form-row">
                                        <div class="col-md-3">{{ form.PCT_application_no|as_crispy_field }}</div>
                                        <div class="col-md-3">{{ form.PCT_application_Date|as_crispy_field }}</div>
                                        <div class="col-md-3">{{ form.application_no|as_crispy_field }}</div>
                                        <div class="col-md-3">{{ form.application_date|as_crispy_field }}</div>
                                    </div>
                                    <div class="form-row">
                                        <div class="col-md-3">{{ form.publication_no|as_crispy_field }}</div>
                                        <div class="col-md-3">{{ form.publication_date|as_crispy_field }}</div>
                                        <div class="col-md-3">{{ form.grant_number|as_crispy_field }}</div>
                                        <div class="col-md-3">{{ form.grant_date|as_crispy_field }}</div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Tab Navigation -->
                        <div class="col-12 mb-4" style="margin-left: -20px;">
                            
                            <div class="tile" style="
                            border: 1px solid #ddd; 
                            border-radius: 10px; 
                            padding: 1px; 
                            background-color: #f9f9f9; 
                            color: #333; 
                            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
                            margin-top: 2px;
                        ">
                            <ul class="nav nav-tabs" id="family-tabs" role="tablist" style="
                                display: flex; 
                                justify-content: space-between; 
                                padding: 0; 
                                margin: 0;
                                
                            ">
                                <li class="nav-item" style="
                                    flex: 1; 
                                    text-align: center; 
                                    border-right: 0.2px solid #aeaeae; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center;">
                                    <a class="nav-link active" id="pills-Actions-tab" data-bs-toggle="pill" href="#pills-Actions" role="tab" aria-controls="pills-Actions" aria-selected="true" style="text-decoration: none; color: #333;">
                                        <b>Actions</b>
                                    </a>
                                </li>
                                <li class="nav-item" style="
                                    flex: 1; 
                                    text-align: center; 
                                    border-right: 0.2px solid #aeaeae; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center;">
                                    <a class="nav-link" id="pills-applicant-tab" data-bs-toggle="pill" href="#pills-applicant" role="tab" aria-controls="pills-applicant" aria-selected="false" style="text-decoration: none; color: #333;">
                                        <b>Applicant(s)</b>
                                    </a>
                                </li>
                                <li class="nav-item" style="
                                    flex: 1; 
                                    text-align: center; 
                                    border-right: 0.2px solid #aeaeae; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center;">
                                    <a class="nav-link" id="pills-Inventors-tab" data-bs-toggle="pill" href="#pills-Inventors" role="tab" aria-controls="pills-Inventors" aria-selected="false" style="text-decoration: none; color: #333;">
                                        <b>Inventor(s)</b>
                                    </a>
                                </li>
                                <li class="nav-item" style="
                                    flex: 1; 
                                    text-align: center; 
                                    border-right: 0.2px solid #aeaeae; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center;">
                                    <a class="nav-link" id="pills-Title-tab" data-bs-toggle="pill" href="#pills-Title" role="tab" aria-controls="pills-Title" aria-selected="false" style="text-decoration: none; color: #333;">
                                        <b>Title</b>
                                    </a>
                                </li>
                                <li class="nav-item" style="
                                    flex: 1; 
                                    text-align: center; 
                                    border-right: 0.2px solid #aeaeae; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center;">
                                    <a class="nav-link" id="pills-Invoices-tab" data-bs-toggle="pill" href="#pills-Invoices" role="tab" aria-controls="pills-Invoices" aria-selected="false" style="text-decoration: none; color: #333;">
                                        <b>Invoices</b>
                                    </a>
                                </li>
                                <li class="nav-item" style="
                                    flex: 1; 
                                    text-align: center; 
                                    border-right: 0.2px solid #aeaeae; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center;">
                                    <a class="nav-link" id="pills-Annuities-tab" data-bs-toggle="pill" href="#pills-Annuities" role="tab" aria-controls="pills-Annuities" aria-selected="false" style="text-decoration: none; color: #333;">
                                        <b>Annuities</b>
                                    </a>
                                </li>
                                <li class="nav-item" style="
                                    flex: 1; 
                                    text-align: center; 
                                    border-right: 0.2px solid #aeaeae; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center;">
                                    <a class="nav-link" id="pills-Related-tab" data-bs-toggle="pill" href="#pills-Related" role="tab" aria-controls="pills-Related" aria-selected="false" style="text-decoration: none; color: #333;">
                                        <b>Related Case Links</b>
                                    </a>
                                </li>
                                <li class="nav-item" style="
                                    flex: 1; 
                                    text-align: center; 
                                    border-right: 0.2px solid #aeaeae; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center;">
                                    <a class="nav-link" id="pills-Abstract-tab" data-bs-toggle="pill" href="#pills-Abstract" role="tab" aria-controls="pills-Abstract" aria-selected="false" style="text-decoration: none; color: #333;">
                                        <b>Abstract & Figures Files</b>
                                    </a>
                                </li>
                                <li class="nav-item" style="
                                    flex: 1; 
                                    text-align: center; 
                                    border-right: 0.2px solid #aeaeae; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center;">
                                    <a class="nav-link" id="pills-Documents-tab" data-bs-toggle="pill" href="#pills-Documents" role="tab" aria-controls="pills-Documents" aria-selected="false" style="text-decoration: none; color: #333;">
                                        <b>Documents</b>
                                    </a>
                                </li>
                                <li class="nav-item" style="
                                    flex: 1; 
                                    text-align: center; 
                                    border-right: 0.2px solid #aeaeae; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center;">
                                    <a class="nav-link" id="pills-names-tab" onclick="displayNamesSection()" role="tab" style="text-decoration: none; color: #333;">
                                        <b>Names</b>
                                    </a>
                                </li>
                                <li class="nav-item" style="
                                    flex: 1; 
                                    text-align: center; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center;">
                                    <a class="nav-link" id="pills-officialnumbers-tab" onclick="displayOfficialNumbersSection()" role="tab" style="text-decoration: none; color: #333;">
                                        <b>Official Numbers</b>
                                    </a>
                                </li>
                            </ul>
                        </div>
<br>
                        
                            
                            <!-- Tab Content -->
                            <div class="tab-content" id="family-tabs-content">
                                <div class="tab-pane fade show active" id="pills-Actions" role="tabpanel" aria-labelledby="pills-Actions-tab">
                                    <div class="media">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th style="text-transform: none;">Action Code</th>
                                                        <th style="text-transform: none;">Action Spellout</th>
                                                        <th style="text-transform: none;">Due Date</th>
                                                        <th style="text-transform: none;">Taken Date</th>
                                                        <th style="text-transform: none;">Completed Date</th>
                                                        <th style="text-transform: none;">Responsible Person</th>
                                                        <th style="text-transform: none;">Notes</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tablebody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="pills-applicant" role="tabpanel" aria-labelledby="pills-applicant-tab">
                                    <div class="media">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Applicant ID</th>
                                                        <th>Surname</th>
                                                        <th>Given Name(s)</th>
                                                        <th>Nationality</th>
                                                        <th>Employment Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="selected-applicant-details"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="pills-Inventors" role="tabpanel" aria-labelledby="pills-Inventors-tab">
                                    <div class="media">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th style="text-transform: none;">Inventor ID</th>
                                                        <th style="text-transform: none;">Surname</th>
                                                        <th style="text-transform: none;">Given Name(s)</th>
                                                        <th style="text-transform: none;">Nationality</th>
                                                        <th style="text-transform: none;">Employment Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td><input type="text" name="inventor_id" oninput="updateInventorFields(this)"></td>
                                                        <td><input type="text" name="surname" oninput="updateInventorFields(this)"></td>
                                                        <td><input type="text" name="given_names" oninput="updateInventorFields(this)"></td>
                                                        <td><input type="text" name="nationality" oninput="updateInventorFields(this)"></td>
                                                        <td><input type="text" name="employment_status" oninput="updateInventorFields(this)"></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="pills-Title" role="tabpanel" aria-labelledby="pills-Title-tab">
                                    <div class="media">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Formal Title</th>
                                                        <th>Internal Title</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="title-table"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="pills-Invoices" role="tabpanel" aria-labelledby="pills-Invoices-tab">
                                    <div class="media">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Invoice No</th>
                                                        <th>Items</th>
                                                        <th>Customer Name</th>
                                                        <th>Address</th>
                                                        <th>Payment Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>CA-0000012</td>
                                                        <td>Service</td>
                                                        <td>Jems</td>
                                                        <td>Kenya</td>
                                                        <td>Pending</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="pills-Annuities" role="tabpanel" aria-labelledby="pills-Annuities-tab">
                                    <div class="media">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Country</th>
                                                        <th>Annuity Year</th>
                                                        <th>Due Date</th>
                                                        <th>Payment Status</th>
                                                        <th>Receipt Received</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="annuity-table-body"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="pills-Related" role="tabpanel" aria-labelledby="pills-Related-tab">
                                    <div class="media">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Reference Number</th>
                                                        <th>Country</th>
                                                        <th>Application Number</th>
                                                        <th>Application Date</th>
                                                        <th>Inventors</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="related_case"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="pills-Abstract" role="tabpanel" aria-labelledby="pills-Abstract-tab">
                                    <div class="media">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Abstract</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>
                                                            <form action="/" method="post">
                                                                {% csrf_token %}
                                                                <textarea id="input-text" name="Abstract" rows="10" cols="50" maxlength="50" placeholder="Enter your abstract here..."></textarea>
                                                            </form>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="pills-Documents" role="tabpanel" aria-labelledby="pills-Documents-tab">
                                    <div class="media">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Document</th>
                                                        <th>Name of Document</th>
                                                        <th>Upload Date</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td><input type="file" name="document_file" onchange="uploadDocument(this)"></td>
                                                        <td id="document-name"></td>
                                                        <td id="upload-date"></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="pills-Notes" role="tabpanel" aria-labelledby="pills-Notes-tab">
                                    <div class="media">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Note</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td><form><input type="text" class="text"></form></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="names-section-content" role="tabpanel" aria-labelledby="pills-names-tab">
                                    <!-- Fields for Names will appear here dynamically -->
                                </div>
                                <div class="tab-pane fade" id="official-numbers-section-content" role="tabpanel" aria-labelledby="pills-officialnumbers-tab">
                                    <!-- Fields for Official Numbers will appear here dynamically -->
                                </div>
                            </div>
                        </div>
                        <!-- End of Tab Navigation -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block js %}
<!-- Required Js -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="{% static 'assets/js/vendor-all.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/bootstrap.min.js' %}"></script>
<script src="{% static 'assets/js/ripple.js' %}"></script>
<script src="{% static 'assets/js/pcoded.min.js' %}"></script>
<!-- select2 Js -->
<script src="{% static 'assets/js/plugins/select2.full.min.js' %}"></script>
<!-- datatables Js -->
<script src="{% static 'assets/js/plugins/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/dataTables.bootstrap4.min.js' %}"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Helper functions for setting form values
        function setInputValue(form, fieldName, value) {
            const inputField = form.querySelector(`input[name="${fieldName}"]`);
            if (inputField) {
                inputField.value = value || '';
            }
        }

        function setSelectValue(form, fieldName, value) {
            const selectField = form.querySelector(`select[name="${fieldName}"]`);
            if (selectField) {
                selectField.value = value || '';
                selectField.dispatchEvent(new Event('change'));
            }
        }

        function populateFormFields(form, data, country) {
            setInputValue(form, "case_no", data.case_no);
            setInputValue(form, "internal_title", data.internal_title);
            setInputValue(form, "formal_title", data.formal_title);
            setSelectValue(form, "cost_centre_code", data.cost_centre_code);
            setSelectValue(form, "primary_attorney", data.primary_attorney);
            setSelectValue(form, "secondary_attorney", data.secondary_attorney);
            setSelectValue(form, "primary_paralegal", data.primary_paralegal);
            setSelectValue(form, "secondary_paralegal", data.secondary_paralegal);
            setSelectValue(form, "licence", data.licenced);
            setSelectValue(form, "type_of_filing", data.type_of_filing);
            setSelectValue(form, "family", data.family);
            setInputValue(form, "country", country);
        }

        // Function to populate due dates in the action table
        function populateDueDates(baseDate, actions, tableId) {
            const table = document.getElementById(tableId);
            actions.forEach(action => {
                const dueDate = new Date(baseDate);
                dueDate.setMonth(dueDate.getMonth() + action.offset);
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${action.code}</td>
                    <td>${action.description}</td>
                    <td>${dueDate.toLocaleDateString('en-GB')}</td>
                    <td><input type="date" ></td>
                    <td><input type="date" class="close-date" data-code="${action.code}"></td>
                    <td><input type="text"></td>
                    <td><input type="text"></td>
                `;
                table.appendChild(row);
            });

            // Add close date functionality
            handleCloseDates();
        }

        // Handle close dates: Removes a row 2 seconds after a close date is provided
        function handleCloseDates() {
            const closeDateInputs = document.querySelectorAll(".close-date");
            closeDateInputs.forEach(input => {
                input.addEventListener("change", function () {
                    // Check if a close date has been entered
                    if (input.value) {
                        const row = input.closest("tr");
                        // Delay removal of row by 2 seconds after close date is entered
                        setTimeout(() => {
                            row.remove(); // Remove the row from the table
                        }, 2000); // 2-second delay
                    }
                });
            });
        }

        // Define action groups
        const universalActions = [
            { code: 'FFREM3', description: 'Foreign Filing Due in 3 months', offset: 9 },
            { code: 'FFREM2', description: 'Foreign Filing Due in 2 months', offset: 10 },
            { code: 'FFREM1', description: 'Foreign Filing Due in 1 month', offset: 11 },
            { code: 'FF', description: 'Foreign Filing due', offset: 12 }
        ];

        const gbActions = [
            { code: "AF1A", description: "Pay Application Fee", offset: 12 },
            { code: "F7", description: "File Form 7 - Inventor Details", offset: 16 },
            { code: "F9", description: "File Form 9 – Search and Fee", offset: 12 },
            { code: "F10", description: "File Form 10 – Sub. Exam and Fee", offset: 24 },
            { code: "ACC", description: "Acceptance", offset: 54 }
        ];

        const nationalPhaseActions = [
            { code: "NPREM3", description: "National Phase Filing Reminder (3 months)", offset: 27 },
            { code: "NPREM2", description: "National Phase Filing Reminder (2 months)", offset: 28 },
            { code: "NPREM1", description: "National Phase Filing Reminder (1 month)", offset: 29 },
            { code: "NP30", description: "National/Regional Phase Entry (30 months)", offset: 30 },
            { code: "NP31", description: "National/Regional Phase Entry (31 months)", offset: 31 }
        ];

        const conditionalActions = [
            { code: 'CER', description: 'Certified Copy of Priority document due', offset: 16 },
            { code: 'NP', description: 'National/Regional Phase Entry due (30/31 months)', offset: 30 },
            { code: 'PUB', description: 'Check application has published', offset: 18 },
            { code: 'ISR', description: 'Check ISR issued', offset: 4, base: 'pct' },
            { code: 'WOSA1', description: 'Respond to WOSA', offset: 3, base: 'pct' },
            { code: 'DEM', description: 'File Demand', offset: 19 },
            { code: 'WOSA2', description: 'Respond to WOSA (later)', offset: 22 },
            { code: 'IPRP', description: 'Check IPRP been issued', offset: 28 }
        ];

        const examRules = {
            "AU": { code: "REQ", description: "Request Exam - Calculated 5 years from PCT/International Filing date", offset: 60 },
            "BR": { code: "REQ", description: "Request Exam - Calculated 36 months from International Filing date", offset: 36 },
            "CA": { code: "REQ", description: "Request Exam - Calculated 5 years from International Filing date", offset: 60 },
            "CL": { code: "REQ", description: "Request Exam - Calculated 60 days from expiration of the time limit for opposition", offset: 2 },
            "CN": { code: "REQ", description: "Request Exam - Calculated 3 years from priority date", offset: 36 },
            "IN": { code: "REQ", description: "Request Exam - Calculated 48 months from earliest priority date", offset: 48 },
            "JP": { code: "REQ", description: "Request Exam - Calculated 3 years from International Filing date", offset: 36 },
            "KR": { code: "REQ", description: "Request Exam - Calculated 5 years from International Filing date", offset: 60 },
            "MY": { code: "REQ", description: "Request Exam - Calculated 4 years from international filing date", offset: 48 },
            "NZ": { code: "REQ", description: "Request Exam - Calculated 5 years from international filing date", offset: 60 },
            "PE": { code: "REQ", description: "Request Exam on filing or within 6 months from publication", offset: 6 },
            "PH": { code: "REQ", description: "Automatic but fee needs to be paid within 6 months from national phase entry date", offset: 6 },
            "RU": { code: "REQ", description: "Request Exam - Calculated 3 years from international filing date", offset: 36 },
            "SG": { code: "REQ", description: "Request Exam - Calculated 36 months and 54 months from earliest priority", offset: 36 },
            "ZA": { code: "NA", description: "No Exam Required", offset: 0 }
        };

        // Apply rules based on conditions
        function applyActionRules() {
            const countrySelect = document.getElementById("id_country");
            const priorityProvisionalDateInput = document.getElementById("id_priority_provisional_date");
            const pctApplicationDateInput = document.getElementById("id_PCT_application_Date");
            const caseTypeInput = document.getElementById("id_case_type");

            const tableBody = document.getElementById("tablebody");
            tableBody.innerHTML = ""; // Clear existing rows before applying rules

            let actionsToDisplay = [];

            // Rules calculated from provisional date
            if (priorityProvisionalDateInput && priorityProvisionalDateInput.value && countrySelect && countrySelect.value) {
                const baseDate = new Date(priorityProvisionalDateInput.value);
                actionsToDisplay = [...universalActions];
                if (countrySelect.value === "GB") {
                    actionsToDisplay.push(...gbActions);
                }
                populateDueDates(baseDate, actionsToDisplay, "tablebody");
            }

            // Rules calculated from PCT date
            if (pctApplicationDateInput && pctApplicationDateInput.value && caseTypeInput && caseTypeInput.value === "Patent Application") {
                const pctBaseDate = new Date(pctApplicationDateInput.value);
                populateDueDates(pctBaseDate, [...nationalPhaseActions, ...conditionalActions], "tablebody");
                if (countrySelect && examRules[countrySelect.value]) {
                    populateDueDates(pctBaseDate, [examRules[countrySelect.value]], "tablebody");
                }
            }
        }

        // Event listeners to trigger rule application on relevant changes
        document.getElementById("id_country").addEventListener("change", applyActionRules);
        document.getElementById("id_priority_provisional_date").addEventListener("change", applyActionRules);
        document.getElementById("id_PCT_application_Date").addEventListener("change", applyActionRules);
        document.getElementById("id_case_type").addEventListener("change", applyActionRules);

        // Initial call to apply rules on page load
        applyActionRules();
    });
</script>


<script>
  // Populate tables based on tab click events
  document.getElementById("pills-Related-tab").addEventListener("click", function () {
    const familyCaseNumber = document.getElementById("id_case_no").value;

    fetch("/app/modules/related_cases_view", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: `family_case_number=${familyCaseNumber}`
    })
    .then(response => response.json())
    .then(data => {
      const relatedCases = data.related_cases.filter(caseData => caseData.case_number === familyCaseNumber);
      const tableBody = document.getElementById("related_case");
      tableBody.innerHTML = "";  // Clear previous entries

      relatedCases.forEach(caseData => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${caseData.case_number}</td>
          <td>${caseData.country}</td>
          <td>${caseData.application_number}</td>
          <td>${caseData.application_date}</td>
          <td>${caseData.inventors}</td>
        `;
        tableBody.appendChild(row);
      });
    })
    .catch(error => console.error("Error fetching related cases:", error));
  });
</script>

<script>
  // Populate and handle specific date rules for form fields
  document.getElementById("id_application_date").addEventListener("change", function() {
    document.getElementById("id_status").value = "Pending";
  });
  document.getElementById("id_PCT_application_Date").addEventListener("change", function() {
    document.getElementById("id_status").value = "Allowed";
  });
  document.getElementById("id_grant_date").addEventListener("change", function() {
    document.getElementById("id_status").value = "Granted(Live)";
  });
  document.getElementById("id_publication_date").addEventListener("change", function() {
    document.getElementById("id_status").value = "Published";
  });
  document.getElementById("id_priority_provisional_date").addEventListener("change", function() {
    document.getElementById("id_status").value = "Filed";
  });
</script>

<script>
  // Method to extract and populate titles
  function extractAndPopulateTitles() {
    const internalTitle = document.getElementById("id_internal_title").value;
    const formalTitle = document.getElementById("id_formal_title").value;
    const tableRow = document.getElementById("title-table");

    tableRow.innerHTML = `
      <td>${formalTitle}</td>
      <td>${internalTitle}</td>
    `;
  }

  // Add event listeners to both title fields to trigger updates on input
  document.getElementById("id_internal_title").addEventListener("input", extractAndPopulateTitles);
  document.getElementById("id_formal_title").addEventListener("input", extractAndPopulateTitles);

  // Ensure the titles are populated when the tab is clicked
  document.getElementById("pills-Title-tab").addEventListener("click", extractAndPopulateTitles);
</script>


<script>
  // Method to update inventor fields
  function updateInventorFields(inputField) {
    const query = inputField.value;
    if (query.trim() === '') {
      return;
    }

    const url = "{% url 'inventor_autocomplete' %}?query=" + query;

    fetch(url)
      .then(response => response.json())
      .then(data => {
        const tr = inputField.closest('tr');
        const [inventorNo, surname, givenNames, nationality, employmentStatus] = tr.querySelectorAll('input[type="text"]');

        if (data.suggestions.length > 0) {
          const bestMatch = data.suggestions[0];
          inventorNo.value = bestMatch.id;
          surname.value = bestMatch.surname;
          givenNames.value = bestMatch.name;
          nationality.value = bestMatch.nationality;
          employmentStatus.value = bestMatch.employer_name;
        } else {
          surname.value = '';
          givenNames.value = '';
          nationality.value = '';
          employmentStatus.value = '';
        }
      })
      .catch(error => {
        console.error("Error fetching inventor data:", error);
      });
  }
</script>
<script>
    // Function to toggle sections expanding and compressing
    function toggleSection(sectionId, toggleElement) {
            const section = document.getElementById(sectionId);
            const icon = toggleElement.querySelector('span');

            if (section.classList.contains('show')) {
                section.classList.remove('show');
                icon.innerText = '+';
            } else {
                section.classList.add('show');
                icon.innerText = '-';
            }
        }

        // JS to ensure the checkboxes are properly aligned into columns
        document.addEventListener('DOMContentLoaded', function () {
            const checkboxes = document.querySelectorAll('.status-checkbox input[type="checkbox"]');
            const container = document.querySelector('.status-checkbox');

            if (container && checkboxes.length) {
                const columns = 5; // Number of columns
                const rows = Math.ceil(checkboxes.length / columns);
                container.style.gridTemplateRows = `repeat(${rows}, auto)`;
            }
        });
  </script>
  <script>
    // JS Functions
    function displayNamesSection() {
        const namesSection = document.getElementById("names-section");
        const namesContent = document.getElementById("names-section-content");
        namesContent.innerHTML = ""; // Clear content
        while (namesSection.firstChild) {
            namesContent.appendChild(namesSection.firstChild);
        }
        namesContent.classList.add("show", "active");
        document.getElementById("official-numbers-section-content").classList.remove("show", "active");
    }

    function displayOfficialNumbersSection() {
        console.log("I have been clicked");
        const officialNumbersSection = document.getElementById("official-numbers-section");
        const officialNumbersContent = document.getElementById("official-numbers-section-content");
        officialNumbersContent.innerHTML = ""; // Clear content
        while (officialNumbersSection.firstChild) {
            officialNumbersContent.appendChild(officialNumbersSection.firstChild);
        }
        officialNumbersContent.classList.add("show", "active");
        console.log("I am showing the table now")
        document.getElementById("names-section-content").classList.remove("show", "active");
    }
</script>
  

{% endblock js %}
